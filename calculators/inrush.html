<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relay Soft-Start Power Supply Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }
        
        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: #1a1a1a;
            border: 2px solid #333;
            box-shadow: 0 0 40px rgba(32, 142, 204, 0.3), inset 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        .header {
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            color: #208ecc;
            padding: 25px 30px;
            border-bottom: 3px solid #208ecc;
            position: relative;
        }
        
        .header::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #208ecc, transparent);
            box-shadow: 0 0 10px #208ecc;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(32, 142, 204, 0.5);
        }
        
        .header p {
            font-size: 12px;
            opacity: 0.7;
            color: #aaa;
            letter-spacing: 1px;
        }
        
        .content {
            padding: 30px;
        }
        
        .input-section {
            background: #252525;
            padding: 20px;
            border: 1px solid #444;
            margin-bottom: 25px;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.5);
        }
        
        .input-section h2 {
            font-size: 14px;
            color: #208ecc;
            margin-bottom: 15px;
            letter-spacing: 2px;
            text-transform: uppercase;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
        }
        
        .input-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            align-items: end;
        }
        
        .input-group {
            margin-bottom: 0;
        }
        
        .input-group label {
            display: block;
            font-weight: 400;
            margin-bottom: 6px;
            color: #aaa;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .input-group input {
            width: 100%;
            padding: 10px;
            background: #0a0a0a;
            border: 1px solid #444;
            color: #208ecc;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #208ecc;
            box-shadow: 0 0 10px rgba(32, 142, 204, 0.3);
            background: #000;
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(180deg, #208ecc 0%, #1a6fa0 100%);
            color: #000;
            border: 2px solid #4ab3e0;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: 'Courier New', monospace;
            box-shadow: 0 4px 15px rgba(32, 142, 204, 0.4);
        }
        
        button:hover {
            background: linear-gradient(180deg, #4ab3e0 0%, #208ecc 100%);
            box-shadow: 0 0 25px rgba(32, 142, 204, 0.6);
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .results {
            display: none;
            margin-top: 30px;
        }
        
        .result-card {
            background: #252525;
            border: 1px solid #444;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.5);
        }
        
        .result-card h3 {
            font-size: 12px;
            color: #208ecc;
            margin-bottom: 15px;
            letter-spacing: 2px;
            text-transform: uppercase;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #2a2a2a;
            font-size: 13px;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-label {
            color: #888;
            font-weight: 400;
        }
        
        .result-value {
            font-weight: bold;
            color: #00ff88;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 5px rgba(0, 255, 136, 0.3);
        }
        
        .alert {
            padding: 12px 15px;
            margin-top: 15px;
            border-left: 3px solid;
            background: rgba(0, 0, 0, 0.3);
            font-size: 12px;
            line-height: 1.5;
        }
        
        .alert::before {
            font-size: 14px;
            margin-right: 10px;
            font-weight: bold;
        }
        
        .alert-success {
            border-color: #00ff88;
            color: #00ff88;
        }
        
        .alert-success::before {
            content: "[OK]";
        }
        
        .alert-warning {
            border-color: #ffaa00;
            color: #ffaa00;
        }
        
        .alert-warning::before {
            content: "[!]";
        }
        
        .alert-danger {
            border-color: #ff3333;
            color: #ff3333;
        }
        
        .alert-danger::before {
            content: "[X]";
        }
        
        .recommendation {
            background: rgba(32, 142, 204, 0.1);
            border: 1px solid #208ecc;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 0 20px rgba(32, 142, 204, 0.2);
        }
        
        .recommendation h4 {
            color: #208ecc;
            margin-bottom: 10px;
            font-size: 12px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        .recommendation p {
            color: #ccc;
            line-height: 1.6;
            font-size: 13px;
        }
        
        .recommendation strong {
            color: #00ff88;
            text-shadow: 0 0 5px rgba(0, 255, 136, 0.3);
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .chart-card {
            background: #252525;
            border: 1px solid #444;
            padding: 20px;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.5);
        }
        
        .chart-card h3 {
            font-size: 12px;
            color: #208ecc;
            margin-bottom: 15px;
            letter-spacing: 2px;
            text-transform: uppercase;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
        }
        
        .chart-wrapper {
            position: relative;
            background: #0a0a0a;
            padding: 10px;
            border: 1px solid #333;
        }
        
        canvas {
            width: 100%;
            height: 300px;
            display: block;
        }
        
        @media (max-width: 900px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>RELAY SOFT-START CALCULATOR</h1>
            <p>LM3886 AMPLIFIER â€¢ POWER SUPPLY PROTECTION CIRCUIT DESIGN</p>
        </div>
        
        <div class="content">
            <div class="input-section">
                <h2>System Parameters</h2>
                <div class="input-row">
                    <div class="input-group">
                        <label for="secondaryVoltage">Secondary (VAC)</label>
                        <input type="number" id="secondaryVoltage" value="24" step="0.1" min="0">
                    </div>
                    <div class="input-group">
                        <label for="relayRated">Relay Rated (VDC)</label>
                        <input type="number" id="relayRated" value="24" step="0.1" min="0">
                    </div>
                    <div class="input-group">
                        <label for="relayOperate">Must Operate (VDC)</label>
                        <input type="number" id="relayOperate" value="" placeholder="Auto" step="0.1" min="0">
                    </div>
                    <div class="input-group">
                        <label for="coilResistance">Coil Res (Î©)</label>
                        <input type="number" id="coilResistance" value="1000" step="1" min="0">
                    </div>
                    <div class="input-group">
                        <label for="chargeResistance">Charge Res (Î©)</label>
                        <input type="number" id="chargeResistance" value="100" step="0.1" min="0">
                    </div>
                    <div class="input-group">
                        <label for="capacitance">Capacitance (ÂµF)</label>
                        <input type="number" id="capacitance" value="20000" step="100" min="0">
                    </div>
                    <div class="input-group">
                        <label for="esrResistance">Circuit ESR (Î©)</label>
                        <input type="number" id="esrResistance" value="2" step="0.1" min="0.1">
                    </div>
                    <div class="input-group">
                        <label for="simDuration">Sim Duration (ms)</label>
                        <input type="number" id="simDuration" value="1000" step="10" min="10">
                    </div>
                    <div class="input-group">
                        <label for="timeStep">Time Step (ms)</label>
                        <input type="number" id="timeStep" value="0.5" step="0.1" min="0.01">
                    </div>
                </div>
            </div>
            
            <button onclick="calculate()">â–¶ Calculate Design Parameters</button>
            
            <div class="results" id="results">
                <div class="result-card">
                    <h3>Power Supply Output</h3>
                    <div class="result-item">
                        <span class="result-label">Rectified DC Voltage</span>
                        <span class="result-value" id="rectifiedVoltage">-</span>
                    </div>
                </div>
                
                <div class="result-card">
                    <h3>Relay Validation</h3>
                    <div id="relayValidation"></div>
                </div>
                
                <div class="result-card">
                    <h3>Recommended Design</h3>
                    <div class="result-item">
                        <span class="result-label">Zener Diode Voltage</span>
                        <span class="result-value" id="zenerVoltage">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Series Resistance</span>
                        <span class="result-value" id="seriesResistance">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Series Resistor Power Rating</span>
                        <span class="result-value" id="resistorPower">-</span>
                    </div>
                </div>
                
                <div class="result-card">
                    <h3>Operating Conditions</h3>
                    <div class="result-item">
                        <span class="result-label">Relay Activation Voltage</span>
                        <span class="result-value" id="activationVoltage">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Peak Inrush Current (at relay switch)</span>
                        <span class="result-value" id="peakInrushCurrent">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Steady-State Relay Voltage</span>
                        <span class="result-value" id="steadyStateVoltage">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Steady-State Relay Current</span>
                        <span class="result-value" id="relayCurrent">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Zener Current (at full VCC)</span>
                        <span class="result-value" id="zenerCurrent">-</span>
                    </div>
                </div>
                
                <div id="recommendations"></div>
                
                <div class="charts-container">
                    <div class="chart-card">
                        <h3>Capacitor Voltage vs Time</h3>
                        <div class="chart-wrapper">
                            <canvas id="voltageChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Charging Current vs Time</h3>
                        <div class="chart-wrapper">
                            <canvas id="currentChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Auto-populate must operate voltage when relay rated changes
        document.getElementById('relayRated').addEventListener('input', function() {
            const rated = parseFloat(this.value);
            if (!isNaN(rated) && !document.getElementById('relayOperate').value) {
                document.getElementById('relayOperate').placeholder = `Auto: ${(rated * 0.8).toFixed(1)}V`;
            }
        });
        
        function calculate() {
            // Get inputs
            const vSecondary = parseFloat(document.getElementById('secondaryVoltage').value);
            const vRelayRated = parseFloat(document.getElementById('relayRated').value);
            let vRelayOperate = parseFloat(document.getElementById('relayOperate').value);
            const rCoil = parseFloat(document.getElementById('coilResistance').value);
            
            // Use default if not specified
            if (isNaN(vRelayOperate)) {
                vRelayOperate = vRelayRated * 0.8;
            }
            
            // Calculate rectified DC (peak voltage with ~5% loss for diode drops and ripple)
            const vRectified = vSecondary * Math.sqrt(2) * 0.95;
            
            // Display rectified voltage
            document.getElementById('rectifiedVoltage').textContent = `${vRectified.toFixed(1)} VDC`;
            
            // Calculate peak inrush current (will be set after simulation)
            // This is a placeholder - the actual value will be calculated in plotCharging()
            
            // Validate relay choice
            let validationHTML = '';
            const activationPercent = (vRelayOperate / vRectified) * 100;
            const ratedPercent = (vRelayRated / vRectified) * 100;
            
            validationHTML += `<div class="result-item">
                <span class="result-label">Relay activates at</span>
                <span class="result-value">${activationPercent.toFixed(1)}% of rail voltage</span>
            </div>`;
            
            if (vRelayRated < vRectified * 0.6) {
                validationHTML += `<div class="alert alert-warning">
                    Relay rated voltage is quite low (${ratedPercent.toFixed(0)}% of rail). Consider a higher voltage relay.
                </div>`;
            } else if (vRelayRated > vRectified * 0.95) {
                validationHTML += `<div class="alert alert-danger">
                    Relay rated voltage is too close to rail voltage! Choose a lower voltage relay.
                </div>`;
            } else {
                validationHTML += `<div class="alert alert-success">
                    Relay voltage rating is appropriate for this supply.
                </div>`;
            }
            
            // Calculate recommended zener voltage (midpoint between operate and rated)
            const vZener = (vRelayOperate + vRelayRated) / 2;
            const zenerMarginLow = ((vZener - vRelayOperate) / vRelayOperate * 100).toFixed(0);
            const zenerMarginHigh = ((vRelayRated - vZener) / vRelayRated * 100).toFixed(0);
            
            // Round to nearest standard zener value
            const standardZeners = [3.3, 3.9, 4.7, 5.1, 5.6, 6.2, 6.8, 7.5, 8.2, 9.1, 10, 11, 12, 13, 15, 16, 18, 20, 22, 24, 27, 30, 33, 36, 39, 43, 47, 51, 56, 62, 68, 75];
            let vZenerStd = standardZeners.reduce((prev, curr) => 
                Math.abs(curr - vZener) < Math.abs(prev - vZener) ? curr : prev
            );
            
            // Calculate series resistance
            // Target: zener current in the middle of goldilocks zone (15mA) at full VCC
            const iZenerTarget = 0.015; // 15mA - middle of 5-25mA range
            const iRelayAtZener = vZenerStd / rCoil;
            const iTotalTarget = iRelayAtZener + iZenerTarget;
            const rSeries = (vRectified - vZenerStd) / iTotalTarget;
            
            // Round to practical value
            let rSeriesStd;
            if (rSeries < 100) {
                rSeriesStd = Math.round(rSeries / 10) * 10;
            } else if (rSeries < 1000) {
                rSeriesStd = Math.round(rSeries / 50) * 50;
            } else {
                rSeriesStd = Math.round(rSeries / 100) * 100;
            }
            
            // Calculate actual operating conditions with standard values
            // When zener is conducting (at full VCC), voltage across relay is clamped at vZener
            const iRelay = vZenerStd / rCoil;
            const iTotal = (vRectified - vZenerStd) / rSeriesStd;
            const iZener = iTotal - iRelay;
            
            // Power dissipation in series resistor
            const pResistor = Math.pow(iTotal, 2) * rSeriesStd;
            const resistorRating = pResistor < 0.125 ? "1/8W" : 
                                  pResistor < 0.25 ? "1/4W" :
                                  pResistor < 0.5 ? "1/2W" :
                                  pResistor < 1 ? "1W" : "2W";
            
            // Display results
            document.getElementById('zenerVoltage').textContent = 
                `${vZenerStd}V (${zenerMarginLow}% above operate, ${zenerMarginHigh}% below rated)`;
            document.getElementById('seriesResistance').textContent = `${rSeriesStd}Î©`;
            document.getElementById('resistorPower').textContent = 
                `${resistorRating} (dissipates ${pResistor.toFixed(2)}W)`;
            document.getElementById('activationVoltage').textContent = 
                `${vRelayOperate.toFixed(1)}V (${activationPercent.toFixed(0)}% of rail)`;
            document.getElementById('steadyStateVoltage').textContent = 
                `${vZenerStd.toFixed(1)}V (clamped by zener)`;
            document.getElementById('relayCurrent').textContent = `${(iRelay * 1000).toFixed(1)}mA`;
            document.getElementById('zenerCurrent').textContent = `${(iZener * 1000).toFixed(1)}mA`;
            
            // Recommendations
            let recHTML = '';
            
            if (iZener < 0.005) {
                recHTML += `<div class="alert alert-warning">
                    Zener current is low (${(iZener * 1000).toFixed(1)}mA). Consider reducing series resistance for better regulation.
                </div>`;
            } else if (iZener > 0.025) {
                recHTML += `<div class="alert alert-warning">
                    Zener current is high (${(iZener * 1000).toFixed(1)}mA). Consider increasing series resistance to reduce power dissipation.
                </div>`;
            } else {
                recHTML += `<div class="alert alert-success">
                    Zener current is in the optimal range (5-25mA) for good regulation.
                </div>`;
            }
            
            recHTML += `<div class="recommendation">
                <h4>ðŸ’¡ Design Summary</h4>
                <p>Use a <strong>${vZenerStd}V, 2W</strong> zener diode in series with a <strong>${rSeriesStd}Î© ${resistorRating}</strong> resistor. 
                The relay will engage when the supply reaches approximately ${vRelayOperate.toFixed(1)}V 
                (${activationPercent.toFixed(0)}% charged), providing effective soft-start protection for your LM3886 amplifier.</p>
            </div>`;
            
            document.getElementById('recommendations').innerHTML = recHTML;
            document.getElementById('relayValidation').innerHTML = validationHTML;
            
            // Show results
            document.getElementById('results').style.display = 'block';
            
            // Calculate and plot capacitor charging
            plotCharging();
            
            // Smooth scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function plotCharging() {
            const vRectified = parseFloat(document.getElementById('secondaryVoltage').value) * Math.sqrt(2) * 0.95;
            const rCharge = parseFloat(document.getElementById('chargeResistance').value);
            const capacitance = parseFloat(document.getElementById('capacitance').value) * 1e-6; // Convert ÂµF to F
            const rESR = parseFloat(document.getElementById('esrResistance').value);
            const simDuration = parseFloat(document.getElementById('simDuration').value) / 1000; // Convert ms to s
            const timeStep = parseFloat(document.getElementById('timeStep').value) / 1000; // Convert ms to s
            let vRelayOperate = parseFloat(document.getElementById('relayOperate').value);
            const vRelayRated = parseFloat(document.getElementById('relayRated').value);
            
            if (isNaN(vRelayOperate)) {
                vRelayOperate = vRelayRated * 0.8;
            }
            
            // Time constant with charge resistance: Ï„1 = R_charge * C
            const tau1 = rCharge * capacitance;
            
            // Find time when relay operates: V(t) = vRelayOperate
            // vRelayOperate = vRectified * (1 - e^(-t/Ï„1))
            // Solving for t: t = -Ï„1 * ln(1 - vRelayOperate/vRectified)
            const tRelay = -tau1 * Math.log(1 - vRelayOperate / vRectified);
            
            // After relay operates, use ESR from input
            const tau2 = rESR * capacitance;
            
            // Generate data points
            const timeData = [];
            const voltageData = [];
            const currentData = [];
            
            const numPoints = Math.ceil(simDuration / timeStep);
            const dt = simDuration / numPoints;
            
            // Calculate peak inrush current at relay switch point
            const vRemaining = vRectified - vRelayOperate;
            const peakInrushCurrent = vRemaining / rESR; // in Amps
            
            for (let i = 0; i <= numPoints; i++) {
                const t = i * dt;
                
                if (t <= tRelay) {
                    // Phase 1: Before relay operates (with charge resistance)
                    const v = vRectified * (1 - Math.exp(-t / tau1));
                    const current = (vRectified / rCharge) * Math.exp(-t / tau1);
                    
                    timeData.push(t * 1000); // Convert to ms
                    voltageData.push(v);
                    currentData.push(current * 1000); // Convert to mA
                } else {
                    // Phase 2: After relay operates (charge resistance bypassed)
                    const t2 = t - tRelay;
                    
                    // V(t) = V_relay + V_remaining * (1 - e^(-t2/Ï„2))
                    const v = vRelayOperate + vRemaining * (1 - Math.exp(-t2 / tau2));
                    // I(t) = (V_remaining/R_ESR) * e^(-t2/Ï„2)
                    const current = (vRemaining / rESR) * Math.exp(-t2 / tau2);
                    
                    timeData.push(t * 1000); // Convert to ms
                    voltageData.push(v);
                    currentData.push(current * 1000); // Convert to mA
                }
            }
            
            // Display peak inrush current in Operating Conditions table
            const peakInrushFormatted = peakInrushCurrent >= 1 
                ? `${peakInrushCurrent.toFixed(2)} A` 
                : `${(peakInrushCurrent * 1000).toFixed(0)} mA`;
            document.getElementById('peakInrushCurrent').textContent = peakInrushFormatted;
            
            // Plot voltage chart (linear scale)
            plotChart('voltageChart', timeData, voltageData, 'Voltage (V)', vRectified, vRelayOperate, tRelay * 1000, '#00ff88', true, false, null);
            
            // Plot current chart (logarithmic scale) - expand Y axis by ~20% in log space
            const maxCurrent = Math.max(...currentData);
            const expandedMaxCurrent = maxCurrent * Math.pow(10, 0.2); // 20% increase in log scale
            plotChart('currentChart', timeData, currentData, 'Current (mA)', expandedMaxCurrent, vRelayOperate, tRelay * 1000, '#208ecc', false, true, peakInrushCurrent * 1000);
        }
        
        function plotChart(canvasId, xData, yData, yLabel, yMax, relayThreshold, relayTime, lineColor, showRelayLine, logScale, peakCurrent) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            // Set canvas resolution
            canvas.width = canvas.offsetWidth * 2;
            canvas.height = canvas.offsetHeight * 2;
            ctx.scale(2, 2);
            
            const width = canvas.offsetWidth;
            const height = canvas.offsetHeight;
            
            // Clear canvas
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, width, height);
            
            // Margins
            const margin = { top: 20, right: 20, bottom: 40, left: 60 };
            const plotWidth = width - margin.left - margin.right;
            const plotHeight = height - margin.top - margin.bottom;
            
            // Scales
            const xMin = 0;
            const xMax = Math.max(...xData);
            let yMin, yMinDisplay;
            
            if (logScale) {
                // For log scale, find minimum non-zero value
                const nonZeroData = yData.filter(y => y > 0);
                yMin = Math.min(...nonZeroData);
                // Round down to nearest power of 10
                yMinDisplay = Math.pow(10, Math.floor(Math.log10(yMin)));
            } else {
                yMin = 0;
                yMinDisplay = 0;
            }
            
            const xScale = (x) => margin.left + (x - xMin) / (xMax - xMin) * plotWidth;
            
            let yScale;
            if (logScale) {
                // Logarithmic scale
                const logMin = Math.log10(yMinDisplay);
                const logMax = Math.log10(yMax);
                yScale = (y) => {
                    if (y <= 0) return margin.top + plotHeight; // Handle zero/negative
                    const logY = Math.log10(y);
                    return margin.top + plotHeight - ((logY - logMin) / (logMax - logMin)) * plotHeight;
                };
            } else {
                // Linear scale
                yScale = (y) => margin.top + plotHeight - (y - yMin) / (yMax - yMin) * plotHeight;
            }
            
            // Grid lines
            ctx.strokeStyle = '#222';
            ctx.lineWidth = 1;
            
            // Horizontal grid lines
            if (logScale) {
                // Log scale: grid lines at powers of 10
                const logMin = Math.log10(yMinDisplay);
                const logMax = Math.log10(yMax);
                const numDecades = logMax - logMin;
                
                // Clamp to reasonable number of grid lines (max 6-7 decades visible)
                const startDecade = Math.floor(logMin);
                const endDecade = Math.ceil(logMax);
                const maxGridLines = 8;
                
                // If we have too many decades, skip some
                let step = 1;
                if (endDecade - startDecade > maxGridLines) {
                    step = Math.ceil((endDecade - startDecade) / maxGridLines);
                }
                
                for (let decade = startDecade; decade <= endDecade; decade += step) {
                    const y = Math.pow(10, decade);
                    if (y < yMinDisplay * 0.9 || y > yMax * 1.1) continue;
                    
                    const yPos = yScale(y);
                    
                    // Only draw if position is within plotting area
                    if (yPos < margin.top || yPos > height - margin.bottom) continue;
                    
                    ctx.beginPath();
                    ctx.moveTo(margin.left, yPos);
                    ctx.lineTo(width - margin.right, yPos);
                    ctx.stroke();
                    
                    // Y-axis labels - show as actual values (not log)
                    ctx.fillStyle = '#666';
                    ctx.font = '10px Courier New';
                    ctx.textAlign = 'right';
                    if (y >= 1000) {
                        ctx.fillText((y/1000).toFixed(0) + 'k', margin.left - 5, yPos + 3);
                    } else if (y >= 1) {
                        ctx.fillText(y.toFixed(0), margin.left - 5, yPos + 3);
                    } else if (y >= 0.01) {
                        ctx.fillText(y.toFixed(2), margin.left - 5, yPos + 3);
                    } else {
                        ctx.fillText(y.toExponential(0), margin.left - 5, yPos + 3);
                    }
                }
            } else {
                // Linear scale: evenly spaced grid lines
                for (let i = 0; i <= 5; i++) {
                    const y = yMin + (yMax - yMin) * i / 5;
                    const yPos = yScale(y);
                    ctx.beginPath();
                    ctx.moveTo(margin.left, yPos);
                    ctx.lineTo(width - margin.right, yPos);
                    ctx.stroke();
                    
                    // Y-axis labels
                    ctx.fillStyle = '#666';
                    ctx.font = '10px Courier New';
                    ctx.textAlign = 'right';
                    ctx.fillText(y.toFixed(1), margin.left - 5, yPos + 3);
                }
            }
            
            // Vertical grid lines
            for (let i = 0; i <= 5; i++) {
                const x = xMin + (xMax - xMin) * i / 5;
                const xPos = xScale(x);
                ctx.beginPath();
                ctx.moveTo(xPos, margin.top);
                ctx.lineTo(xPos, height - margin.bottom);
                ctx.stroke();
                
                // X-axis labels
                ctx.fillStyle = '#666';
                ctx.font = '10px Courier New';
                ctx.textAlign = 'center';
                ctx.fillText(x.toFixed(0), xPos, height - margin.bottom + 15);
            }
            
            // Relay threshold line (horizontal)
            if (showRelayLine && relayThreshold) {
                ctx.strokeStyle = '#ffaa00';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                const yPos = yScale(relayThreshold);
                ctx.beginPath();
                ctx.moveTo(margin.left, yPos);
                ctx.lineTo(width - margin.right, yPos);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Label
                ctx.fillStyle = '#ffaa00';
                ctx.font = '11px Courier New';
                ctx.textAlign = 'left';
                ctx.fillText('RELAY ON', margin.left + 5, yPos - 5);
            }
            
            // Relay activation time line (vertical)
            if (relayTime) {
                ctx.strokeStyle = '#ffaa00';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                const xPos = xScale(relayTime);
                ctx.beginPath();
                ctx.moveTo(xPos, margin.top);
                ctx.lineTo(xPos, height - margin.bottom);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Add peak current annotation if provided (positioned at right edge)
                if (peakCurrent !== null && peakCurrent !== undefined) {
                    const peakLabel = peakCurrent >= 1000 
                        ? `PEAK: ${(peakCurrent/1000).toFixed(2)}A` 
                        : `PEAK: ${peakCurrent.toFixed(0)}mA`;
                    
                    // Position label at right side of plot, right-justified
                    ctx.fillStyle = '#00ff88';
                    ctx.font = 'bold 11px Courier New';
                    ctx.textAlign = 'right';
                    ctx.fillText(peakLabel, width - margin.right - 5, margin.top + 35);
                }
            }
            
            // Plot data
            ctx.strokeStyle = lineColor;
            ctx.lineWidth = 2.5;
            ctx.shadowColor = lineColor;
            ctx.shadowBlur = 5;
            ctx.beginPath();
            ctx.moveTo(xScale(xData[0]), yScale(yData[0]));
            for (let i = 1; i < xData.length; i++) {
                ctx.lineTo(xScale(xData[i]), yScale(yData[i]));
            }
            ctx.stroke();
            ctx.shadowBlur = 0;
            
            // Axes
            ctx.strokeStyle = '#444';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top);
            ctx.lineTo(margin.left, height - margin.bottom);
            ctx.lineTo(width - margin.right, height - margin.bottom);
            ctx.stroke();
            
            // Axis labels
            ctx.fillStyle = '#aaa';
            ctx.font = '12px Courier New';
            ctx.textAlign = 'center';
            ctx.fillText('Time (ms)', width / 2, height - 5);
            
            ctx.save();
            ctx.translate(15, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText(yLabel, 0, 0);
            ctx.restore();
        }
    </script>
</body>
</html>