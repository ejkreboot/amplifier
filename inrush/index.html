<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TI-Style Relay Soft-Start Circuit Designer</title>
  <style>
    :root {
      --bg: #f5f5f0;
      --card: #ffffff;
      --border: #d4d0c8;
      --border-subtle: #e8e6e0;
      --text: #2a2a2a;
      --text-muted: #6b6b6b;
      --accent: #4a7ba7;
      --accent-hover: #3a6a95;
      --accent-light: #e8f0f7;
      --warn: #c97316;
      --bad: #c44e4e;
      --ok: #3e8e5f;
      --shadow: rgba(0, 0, 0, 0.08);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #f8f7f4 0%, #eeede8 100%);
      color: var(--text);
      line-height: 1.5;
    }

    header {
      padding: 22px 18px 10px;
      max-width: 1100px;
      margin: 0 auto;
    }

    h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      letter-spacing: 0.2px;
      color: var(--text);
    }

    h2 {
      margin: 14px 0 8px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    .sub {
      margin-top: 6px;
      color: var(--text-muted);
      font-size: 13px;
      line-height: 1.35;
    }

    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 12px 18px 28px;
      display: grid;
      gap: 14px;
      grid-template-columns: 1.05fr 0.95fr;
    }

    @media (max-width: 920px) {
      main { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px var(--shadow), 0 4px 16px var(--shadow);
    }

    .grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .grid3 {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    input, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: all 0.15s ease;
    }

    input:hover, select:hover { border-color: var(--accent); }
    input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
    }

    .row { display: flex; gap: 10px; align-items: center; justify-content: space-between; }
    .btns { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }

    button {
      padding: 10px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, #ffffff 0%, #f8f8f8 100%);
      color: var(--text);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      box-shadow: 0 1px 2px var(--shadow);
    }

    button:hover {
      border-color: var(--accent);
      background: var(--accent-light);
      transform: translateY(-1px);
      box-shadow: 0 2px 4px var(--shadow);
    }
    button:active { transform: translateY(0); box-shadow: 0 1px 2px var(--shadow); }

    .pill {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: var(--bg);
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 500;
    }

    .tiny { font-size: 12px; color: var(--text-muted); line-height: 1.35; }
    .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; color: var(--accent); background: var(--accent-light); padding: 2px 6px; border-radius: 4px; }

    .status {
      margin-top: 10px;
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
      background: var(--bg);
      font-size: 13px;
    }
    .good { color: var(--ok); font-weight: 600; }
    .warn { color: var(--warn); font-weight: 600; }
    .bad { color: var(--bad); font-weight: 700; }

    .note {
      border-left: 3px solid var(--accent);
      padding-left: 10px;
      background: var(--accent-light);
      padding: 10px 10px 10px 12px;
      border-radius: 0 4px 4px 0;
    }

    /* ===== Advanced disclosure ===== */
    details.adv {
      margin-top: 12px;
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      background: var(--bg);
      padding: 10px 12px;
    }
    details.adv > summary {
      cursor: pointer;
      list-style: none;
      font-weight: 600;
      color: var(--accent);
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: none;
    }
    details.adv > summary::-webkit-details-marker { display:none; }
    details.adv > summary::after {
      content: "▸";
      color: var(--accent);
      font-size: 14px;
      transform: translateY(-1px);
    }
    details.adv[open] > summary::after { content: "▾"; }

    .adv-body { margin-top: 10px; }

    /* ===== Tables ===== */
    .table-wrap {
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      overflow: hidden;
      background: var(--card);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    thead th {
      background: var(--bg);
      color: var(--text-muted);
      font-weight: 700;
      text-transform: none;
      font-size: 12px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-subtle);
    }
    tbody td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-subtle);
      vertical-align: top;
    }
    tbody tr:last-child td { border-bottom: none; }
    td.k { color: var(--text-muted); width: 62%; }
    td.v { text-align: right; font-variant-numeric: tabular-nums; font-weight: 700; }
    .table-foot {
      padding: 10px 12px;
      background: var(--bg);
      border-top: 1px solid var(--border-subtle);
      color: var(--text-muted);
      font-size: 12px;
    }

    .footer {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 18px 22px;
      color: var(--text-muted);
      font-size: 12px;
    }
  </style>
</head>

<body>
<header>
  <h1>TI-Style Relay Soft-Start Circuit Designer</h1>
  <div class="sub">
    Models key values and performance of an inrush circuit as described in
    <a href="https://www.ti.com/lit/an/snaa057c/snaa057c.pdf">Texas Instruments' AN-1849</a>.
  </div>
</header>

<main>
  <!-- Inputs -->
  <section class="card">
    <div class="row">
      <div class="pill">Inputs</div>
    </div>

    <h2>Supply</h2>
    <div class="grid">
      <div>
        <label>Secondary voltage (VAC RMS)</label>
        <input id="vac" type="number" step="0.1" value="24" />
      </div>
    </div>

    <h2>Relay coil</h2>
    <div class="grid3">
      <div>
        <label>Rated coil voltage (V)</label>
        <input id="vRated" type="number" step="0.5" value="24" />
      </div>
      <div>
        <label>Coil resistance (Ω)</label>
        <input id="rCoil" type="number" step="1" value="1600" />
      </div>
    </div>

    <h2>Clamp + resistors</h2>
    <div class="grid3">
      <div>
        <label>Zener clamp Vz (V)</label>
        <input id="vz" type="number" step="0.5" value="26" />
      </div>
      <div>
        <label>Design zener current (mA)</label>
        <input id="izDesign" type="number" step="0.5" value="5" />
      </div>
      <div>
        <label>RZ1 fraction of total (0–1)</label>
        <input id="rz1Frac" type="number" step="0.05" value="0.50" />
      </div>
    </div>

    <details class="adv" id="adv">
      <summary>Advanced inputs</summary>
      <div class="adv-body">
        <div class="tiny" style="margin:0 0 10px;">
          Defaults are reasonable for common silicon bridges and typical relay behavior. Override if you’re near the edge.
        </div>

        <h2 style="margin-top:0;">Supply assumptions</h2>
        <div class="grid3">
          <div>
            <label>Diode Vf per diode (V)</label>
            <input id="vd" type="number" step="0.05" value="0.90" />
          </div>
          <div>
            <label>Mains tolerance (fraction)</label>
            <input id="lineTol" type="number" step="0.01" value="0.10" />
          </div>
          <div>
            <label>Transformer regulation rise (fraction)</label>
            <input id="regRise" type="number" step="0.01" value="0.08" />
          </div>
        </div>

        <h2>Relay threshold assumptions</h2>
        <div class="grid3">
          <div>
            <label>Pickup fraction of rated</label>
            <input id="pickFrac" type="number" step="0.01" value="0.80" />
          </div>
          <div>
            <label>Dropout fraction of rated</label>
            <input id="dropFrac" type="number" step="0.01" value="0.10" />
          </div>
          <div>
            <label>Max continuous fraction of rated</label>
            <input id="maxFrac" type="number" step="0.01" value="1.10" />
          </div>
          <div>
            <label>Pickup margin (V)</label>
            <input id="pickMargin" type="number" step="0.1" value="1.0" />
          </div>
        </div>
      </div>
    </details>

    <div class="btns">
      <button id="presetG7SA">Preset: G7SA 24V (1.6kΩ, 15mA)</button>
      <button id="presetMY4N">Preset: MY4N 24V (662Ω, ~36mA)</button>
      <button id="reset">Reset defaults</button>
    </div>

  </section>

  <!-- Results -->
  <section class="card">
    <div class="row">
      <div class="pill">Results</div>
    </div>

    <h2>Computed rails</h2>
    <div class="table-wrap">
      <table aria-label="Computed rails">
        <thead><tr><th style="text-align:left;">Quantity</th><th style="text-align:right;">Value</th></tr></thead>
        <tbody id="railsBody"></tbody>
      </table>
    </div>

    <h2>Relay thresholds</h2>
    <div class="table-wrap">
      <table aria-label="Relay thresholds">
        <thead><tr><th style="text-align:left;">Quantity</th><th style="text-align:right;">Value</th></tr></thead>
        <tbody id="relayBody"></tbody>
      </table>
    </div>

    <h2>RZ sizing + dissipation</h2>
    <div class="table-wrap">
      <table aria-label="Resistors">
        <thead><tr><th style="text-align:left;">Quantity</th><th style="text-align:right;">Value</th></tr></thead>
        <tbody id="resBody"></tbody>
      </table>
    </div>

    <h2>Zener + coil currents</h2>
    <div class="table-wrap">
      <table aria-label="Zener + coil">
        <thead><tr><th style="text-align:left;">Quantity</th><th style="text-align:right;">Value</th></tr></thead>
        <tbody id="zBody"></tbody>
      </table>
    </div>


    <div class="status" id="status"></div>
  </section>
</main>

<div class="footer">
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  function clamp(x,min,max){ return Math.max(min, Math.min(max,x)); }

  function roundToNiceOhms(x){
    const e12=[1.0,1.2,1.5,1.8,2.2,2.7,3.3,3.9,4.7,5.6,6.8,8.2];
    if(!isFinite(x) || x<=0) return 0;
    const exp=Math.floor(Math.log10(x));
    const base=x/Math.pow(10,exp);
    let best=e12[0], bestErr=1e9;
    for(const b of e12){
      const err=Math.abs(b-base);
      if(err<bestErr){ bestErr=err; best=b; }
    }
    return best*Math.pow(10,exp);
  }

  function setTableRows(tbodyEl, rows){
    tbodyEl.innerHTML = rows.map(r => (
      `<tr><td class="k">${r[0]}</td><td class="v mono">${r[1]}</td></tr>`
    )).join('');
  }

  function compute(){
    // User-visible primary inputs
    const vac    = parseFloat($('vac').value);
    const vRated = parseFloat($('vRated').value);
    const rCoil  = parseFloat($('rCoil').value);

    const vz = parseFloat($('vz').value);
    const izDesign_mA = parseFloat($('izDesign').value);
    const rz1Frac = clamp(parseFloat($('rz1Frac').value), 0, 1);

    // Advanced inputs (hidden by default)
    const vd = parseFloat($('vd').value);             // per diode
    const lineTol = parseFloat($('lineTol').value);
    const regRise = parseFloat($('regRise').value);

    const pickFrac = parseFloat($('pickFrac').value);
    const dropFrac = parseFloat($('dropFrac').value);
    const maxFrac  = parseFloat($('maxFrac').value);
    const pickMargin = parseFloat($('pickMargin').value);

    // Rails (bridge + cap)
    const vpk_nom = vac*Math.SQRT2;
    const vcc_nom = Math.max(0, vpk_nom - 2*vd);

    const vac_max = vac*(1+lineTol)*(1+regRise);
    const vpk_max = vac_max*Math.SQRT2;
    const vcc_max = Math.max(0, vpk_max - 2*vd);

    const vac_min = vac*(1-lineTol); // conservative: ignore regulation drop, assume worst line
    const vpk_min = vac_min*Math.SQRT2;
    const vcc_min = Math.max(0, vpk_min - 2*vd);

    // Relay thresholds (typical)
    const v_pick = vRated*pickFrac;
    const v_drop = vRated*dropFrac;
    const v_maxcoil = vRated*maxFrac;
    const v_pick_target = v_pick + pickMargin;

    // Coil current at clamp
    const i_coil_at_vz = (vz / rCoil); // A
    const izDesign = izDesign_mA/1000; // A

    // Total feed resistance based on worst-case high VCC (clamp-active)
    // Rfeed = (Vcc_max - Vz) / (Icoil(Vz) + Iz_design)
    const vhead = vcc_max - vz;
    const r_feed = (vhead > 0) ? (vhead / (i_coil_at_vz + izDesign)) : 0;

    // Friendly rounding
    const r_feed_nice = roundToNiceOhms(r_feed);

    // Split
    const rz1 = r_feed_nice*rz1Frac;
    const rz2 = r_feed_nice*(1-rz1Frac);

    // Currents at max (clamped)
    const i_feed_max = (r_feed_nice>0) ? ((vcc_max - vz)/r_feed_nice) : 0;
    const i_z_max = Math.max(0, i_feed_max - i_coil_at_vz);

    // Dissipation
    const p_rz1 = i_feed_max*i_feed_max*rz1;
    const p_rz2 = i_feed_max*i_feed_max*rz2;
    const p_z   = vz*i_z_max;
    const p_coil = vz*vz/rCoil;

    // Coil node voltage at low rail (zener likely off), divider approximation
    const vcoil_min = (r_feed_nice>0) ? (vcc_min * (rCoil/(r_feed_nice + rCoil))) : vcc_min;
    const vcoil_nom = (r_feed_nice>0) ? (vcc_nom * (rCoil/(r_feed_nice + rCoil))) : vcc_nom;

    // Fill tables
    setTableRows($('railsBody'), [
      ['VCC nominal (V)', vcc_nom.toFixed(2)],
      ['VCC max (hi line + regulation) (V)', vcc_max.toFixed(2)],
      ['VCC min (low line) (V)', vcc_min.toFixed(2)],
      ['Assumed diode Vf per diode (V)', vd.toFixed(2)],
      ['VAC max used (V RMS)', vac_max.toFixed(2)],
      ['VAC min used (V RMS)', vac_min.toFixed(2)],
    ]);

    setTableRows($('relayBody'), [
      ['Pickup threshold V_pick (V)', v_pick.toFixed(2)],
      ['Pickup target (with margin) (V)', v_pick_target.toFixed(2)],
      ['Dropout V_drop (V)', v_drop.toFixed(2)],
      ['Max continuous coil voltage (V)', v_maxcoil.toFixed(2)],
    ]);

    setTableRows($('resBody'), [
      ['Rfeed = RZ1 + RZ2 (Ω) (suggested)', r_feed_nice.toFixed(0)],
      ['RZ1 (Ω)', rz1.toFixed(0)],
      ['RZ2 (Ω)', rz2.toFixed(0)],
      ['Feed current @ VCCmax, clamped (mA)', (i_feed_max*1000).toFixed(1)],
      ['RZ1 dissipation @ worst case (W)', p_rz1.toFixed(3)],
      ['RZ2 dissipation @ worst case (W)', p_rz2.toFixed(3)],
    ]);

    setTableRows($('zBody'), [
      ['Coil current at Vz (mA)', (i_coil_at_vz*1000).toFixed(1)],
      ['Zener current @ worst case (mA)', (i_z_max*1000).toFixed(1)],
      ['Zener dissipation @ worst case (W)', p_z.toFixed(3)],
      ['Coil dissipation at Vz (W)', p_coil.toFixed(3)],
      ['Coil node at VCCmin (divider approx) (V)', vcoil_min.toFixed(2)],
      ['Coil node at VCCnom (divider approx) (V)', vcoil_nom.toFixed(2)],
    ]);

    // Status messages
    const st = $('status');
    let msgs = [];

    if(vz > v_maxcoil + 1e-9) msgs.push(`<div><span class="bad">Vz is above max continuous coil voltage.</span> Risk of coil heating.</div>`);
    if(vz < v_pick_target - 1e-9) msgs.push(`<div><span class="bad">Vz is below pickup target.</span> May not pull in reliably.</div>`);

    if(vcc_max <= vz) msgs.push(`<div><span class="warn">VCCmax ≤ Vz:</span> zener may never conduct (often fine if coil stays in spec).</div>`);

    if(vcoil_min < v_drop + 0.5) msgs.push(`<div><span class="warn">Coil node at VCCmin is near/below dropout.</span> Relay may drop out on low line or heavy load.</div>`);
    else if(vcoil_min < v_pick) msgs.push(`<div><span class="warn">Coil node at VCCmin is below pickup.</span> Fine after startup, but a deep brownout could release the relay.</div>`);

    if(i_z_max*1000 > 15) msgs.push(`<div><span class="warn">Zener current is fairly high</span> (&gt;15 mA). Consider increasing Rfeed or lowering IzDesign.</div>`);
    if(p_z > 0.75) msgs.push(`<div><span class="warn">Zener dissipation is non-trivial</span> (~${p_z.toFixed(2)} W). Consider higher wattage or tuning Rfeed.</div>`);

    if(p_rz1 > 0.5) msgs.push(`<div><span class="warn">RZ1 runs warm</span> (>${p_rz1.toFixed(2)} W worst case). Use ≥2× wattage margin.</div>`);
    if(p_rz2 > 0.5) msgs.push(`<div><span class="warn">RZ2 runs warm</span> (>${p_rz2.toFixed(2)} W worst case). Use ≥2× wattage margin.</div>`);

    if(msgs.length===0){
      st.innerHTML = `<div class="good">Looks internally consistent.</div><div class="tiny">Pick real resistor/zener wattages with margin, then sanity-check in SPICE if you’re close to limits.</div>`;
    } else {
      st.innerHTML = msgs.join('');
    }
  }

  function bindAll(){
    const idsSimple = ['vac','vRated','rCoil','vz','izDesign','rz1Frac'];
    const idsAdv = ['vd','lineTol','regRise','pickFrac','dropFrac','maxFrac','pickMargin'];
    [...idsSimple, ...idsAdv].forEach(id => {
      $(id).addEventListener('input', compute);
      $(id).addEventListener('change', compute);
    });
  }

  function setPreset(which){
    if(which==='g7sa'){
      $('vRated').value = 24;
      $('rCoil').value = 1600;
      $('vz').value = 26;
      $('izDesign').value = 5;
      $('rz1Frac').value = 0.5;
    } else if(which==='my4n'){
      $('vRated').value = 24;
      $('rCoil').value = 662;
      $('vz').value = 26;
      $('izDesign').value = 5;
      $('rz1Frac').value = 0.5;
    }
    compute();
  }

  function resetDefaults(){
    $('vac').value = 24;
    setPreset('g7sa');

    // Advanced defaults (your hard-coded assumptions, now editable)
    $('vd').value = 0.90;
    $('lineTol').value = 0.10;
    $('regRise').value = 0.08;

    $('pickFrac').value = 0.80;
    $('dropFrac').value = 0.10;
    $('maxFrac').value = 1.10;
    $('pickMargin').value = 1.0;

    compute();
  }

  $('presetG7SA').addEventListener('click', ()=>setPreset('g7sa'));
  $('presetMY4N').addEventListener('click', ()=>setPreset('my4n'));
  $('reset').addEventListener('click', resetDefaults);

  bindAll();
  resetDefaults();
})();
</script>
</body>
</html>
